when Screen1 opens
  set WebView1 URL to "https://hencehuman.github.io/messaging-web-bridge/websocket_listen.html"
  when WebView1 loads
    set Label_Status text to "Testing WebSocket..."
    evaluate JavaScript in WebView1 code "window.testBridge()" then do
      set Label_Status text to result
    catch error
      set Label_Status text to "WebSocket Error: " + error

when Button_Listen click
  call Backendless.UserService getCurrentUser
    then do
      set app variable userToken to result.user-token
      set Label_Debug text to app variable userToken
    else do
      set Label_Error text to "Failed to get user token"
      return
  set app variable channelName to "236E31"
  evaluate JavaScript in WebView1 code "window.startListening('" + app variable userToken + "', '" + app variable channelName + "')" then do
    set Label_Result text to JSON.stringify result
  catch error
    set Label_Result text to "Listen Error: " + error

when WebView1 receives message
  try
    set app variable receivedMessage to JSON.parse message
    set Label_Message text to get property "word" of get property "latestOb" of app variable receivedMessage
  catch error
    set Label_Message text to message
