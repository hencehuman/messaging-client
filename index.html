<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Web Bridge Listener</title>
  <script src="https://cdn.jsdelivr.net/npm/backendless@7/dist/backendless.min.js"></script>
</head>
<body>
  <h2>Listening Bridge Active</h2>

  <script>
    const APP_ID = "9561383D-4BC2-F4F1-FF73-B529BFE77000";
    const API_KEY = "BEE4A193-7ADC-419B-9EB4-202FDA99ACC6";

    // Start listening on command from Thunkable
    window.addEventListener("message", async (event) => {
      console.log("üì© Received message:", event.data);
      let data;

      try {
        data = typeof event.data === "string" ? JSON.parse(event.data) : event.data;
      } catch (e) {
        console.error("‚ùå Failed to parse JSON:", e.message);
        return;
      }

      const token = data.token;
      const channelName = data.channelName;

      if (!token || !channelName) {
        console.warn("‚ùå Missing token or channelName");
        return;
      }

      Backendless.initApp(APP_ID, API_KEY);
      Backendless.UserService.setCurrentUserToken(token);

      try {
        const channel = Backendless.Messaging.subscribe(channelName);
        channel.addMessageListener((message) => {
          const msg = typeof message === "object" ? JSON.stringify(message) : String(message);
          console.log("üì§ Forwarding to WebView:", msg);

          // ‚úÖ Standard cross-platform WebViewer call
          if (window.ReactNativeWebView && window.ReactNativeWebView.postMessage) {
            window.ReactNativeWebView.postMessage(msg);
          } else {
            console.warn("‚ö†Ô∏è ReactNativeWebView.postMessage not available");
          }
        });

        console.log("‚úÖ Subscribed to:", channelName);
      } catch (e) {
        console.error("‚ùå Subscription error:", e.message);
      }
    });

    console.log("üì° WebBridge ready");
  </script>
</body>
</html>
