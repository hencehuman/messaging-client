<!DOCTYPE html>
<html>
<head>
  <title>WebBridge RT Messaging</title>
  <script src="https://cdn.jsdelivr.net/npm/backendless@7/dist/backendless.min.js"></script>
</head>
<body>
  <h2>Messaging Bridge Active</h2>

  <script>
    const APP_ID = "9561383D-4BC2-F4F1-FF73-B529BFE77000";
    const API_KEY_RECEIVE = "BEE4A193-7ADC-419B-9EB4-202FDA99ACC6";
    const API_KEY_PUBLISH = "4CD13851-2D6E-44B6-BB66-5437FCBF0B8C";

    window.addEventListener("message", async (event) => {
      const data = typeof event.data === "string" ? JSON.parse(event.data) : event.data;
      const mode = data.mode;
      const token = data.token;
      const channelName = data.channel;

      if (!mode || !token || !channelName) return;

      if (mode === "listen") {
        Backendless.initApp(APP_ID, API_KEY_RECEIVE);
        Backendless.UserService.setCurrentUserToken(token);

        const channel = Backendless.Messaging.subscribe(channelName);
        channel.addMessageListener((message) => {
          try {
            const safeMessage = JSON.stringify(message || {});
            window.ReactNativeWebView?.postMessage(safeMessage);
          } catch (err) {
            window.ReactNativeWebView?.postMessage(JSON.stringify({ error: "Failed to serialize message" }));
          }
        });

        console.log("‚úÖ Subscribed to:", channelName);
      }

      else if (mode === "publish") {
        Backendless.initApp(APP_ID, API_KEY_PUBLISH);
        Backendless.UserService.setCurrentUserToken(token);

        try {
          const parsedToken = JSON.parse(atob(token.split('.')[1]));
          const objectId = parsedToken.objectId || parsedToken["user-id"];
          const derivedChannel = objectId?.substring(0, 6);
          if (!derivedChannel) throw new Error("Invalid objectId in token");

          const payload = {
            latestOb: data.latestOb || {},
            location: data.location ?? null,
            timestamp: data.timestamp || new Date().toISOString()
          };

          await Backendless.Messaging.publish(derivedChannel, payload, {
            headers: { "user-token": token }
          });

          console.log("üì§ Published to:", derivedChannel);
        } catch (error) {
          console.error("‚ùå Publish error:", error.message);
        }
      }
    });

    console.log("üì° Web Bridge ready");
  </script>
</body>
</html>
