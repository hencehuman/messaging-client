<!DOCTYPE html>
<html>
<head>
  <title>WebBridge RT Messaging</title>
  <script src="https://cdn.jsdelivr.net/npm/backendless@7/dist/backendless.min.js"></script>
</head>
<body>
  <h2>Messaging Bridge Active</h2>

  <script>
    const APP_ID = "9561383D-4BC2-F4F1-FF73-B529BFE77000";

    // Two separate keys
    const API_KEY_RECEIVE = "BEE4A193-7ADC-419B-9EB4-202FDA99ACC6"; // Read-only key
    const API_KEY_PUBLISH = "4CD13851-2D6E-44B6-BB66-5437FCBF0B8C"; // Publish key

    // Determine mode from client input via postMessage
    let mode = "listen"; // or "publish"

    // Wait for Thunkable to post setup config
    window.addEventListener("message", async (event) => {
      const data = typeof event.data === "string" ? JSON.parse(event.data) : event.data;

      if (!data || !data.mode || !data.channel) return;

      mode = data.mode;
      const channelName = data.channel;
      const token = data.token || null;

      if (mode === "listen") {
        Backendless.initApp(APP_ID, API_KEY_RECEIVE);
        if (token) Backendless.UserService.setCurrentUserToken(token);

        const channel = Backendless.Messaging.subscribe(channelName);
        channel.addMessageListener((message) => {
          const msgText = typeof message === "object" ? JSON.stringify(message) : message;
          window.ReactNativeWebView?.postMessage(msgText);
        });

        console.log("âœ… Listening on channel:", channelName);
      }

      else if (mode === "publish") {
        Backendless.initApp(APP_ID, API_KEY_PUBLISH);
        if (token) Backendless.UserService.setCurrentUserToken(token);

        const payload = {
          message: data.message,
          name: data.name,
          listening: data.listening,
          changing: data.changing,
          language: data.language,
          water: data.water,
          word: data.word,
          date: data.date,
          time: data.time,
          timestamp: new Date().toISOString()
        };

        try {
          await Backendless.Messaging.publish(channelName, payload);
          console.log("ğŸ“¤ Message published to", channelName);
        } catch (error) {
          console.error("âŒ Failed to publish:", error.message);
        }
      }
    });

    console.log("ğŸ“¡ Bridge ready to receive instructions from Thunkable...");
  </script>
</body>
</html>
